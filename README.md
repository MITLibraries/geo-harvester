# geo-harvester

Geo-Harvester is a python CLI application for harvesting, normalizing, and writing GIS and geospatial metadata, with a focus on providing this metadata for TIMDEX.

At a high level, this is accomplished by:
1. fetching metadata records generated by MIT (S3) or from OpenGeoMetadata (OGM) repositories (GitHub)
2. normalize this metadata to the [Aardvark metadata format](https://opengeometadata.org/ogm-aardvark/)
3. based on normalized metadata, sending EventBridge events for other applications to potentially move and copy data

## Development

- To install with dev dependencies: `make install`
- To update dependencies: `make update`
- To run unit tests: `make test`
- To lint the repo: `make lint`
- To run the app: `pipenv run harvester --help`

## Environment Variables

### Required
```shell
SENTRY_DSN=### If set to a valid Sentry DSN, enables Sentry exception monitoring. This is not needed for local development.
WORKSPACE=### Set to `dev` for local development, this will be set to `stage` and `prod` in those environments by Terraform.
S3_RESTRICTED_CDN_ROOT=### S3 bucket + prefix for CDN restricted, e.g. 's3://<bucket>/path/to/restricted'
S3_PUBLIC_CDN_ROOT=### S3 bucket + prefix for CDN public, e.g. 's3://<bucket>/path/to/public'
```

### Optional
```shell
GEOHARVESTER_SQS_TOPIC_NAME=### default value for CLI argument --sqs-arn
```

## CLI Commands

All CLI commands can be run with `pipenv run <COMMAND>`.

### `harvester`

```text
Usage: -c [OPTIONS] COMMAND [ARGS]...

  Root harvester command that other sub-commands extend.

Options:
  -v, --verbose  Pass to log at debug level instead of info.
  -h, --help     Show this message and exit.

Commands:
  harvest  Harvest command with sub-commands for different sources.
  ping     Debug ping/pong command
```

### `harvester ping`

```text
Usage: -c ping [OPTIONS]

  Debug ping/pong command.

  This command is purely for debugging purposes to ensure docker container
  and/or application is functional and responsive before any meaningful
  business logic.

Options:
  -h, --help  Show this message and exit.
```

### `harvester harvest`

Base command for harvests. Expecting sub-command `mit` or `ogm`.

```text
Usage: -c harvest [OPTIONS] COMMAND [ARGS]...

  Harvest command with sub-commands for different sources.

Options:
  -t, --harvest-type TEXT  Type of harvest, may be: 'incremental' or 'full'.
  -f, --from-date TEXT     filter for files modified on or after this date;
                           format YYYY-MM-DD.
  -u, --until-date TEXT    filter for files modified before this date; format
                           YYYY-MM-DD.
  -h, --help               Show this message and exit.

Commands:
  mit  Harvest and normalize MIT geospatial metadata records.
  ogm  Harvest and normalize OpenGeoMetadata (OGM) geospatial metadata...
```

### `harvester harvest mit`

```text
Usage: -c harvest mit [OPTIONS]

  Harvest and normalize MIT geospatial metadata records.

Options:
  -i, --input-files TEXT     Directory location of source zip files (may be
                             local or s3). Defaults to env var
                             S3_RESTRICTED_CDN_ROOT if set.  [required]
  -s, --sqs-topic-name TEXT  SQS topic name with messages capturing zip file
                             modifications. Defaults to env var
                             GEOHARVESTER_SQS_TOPIC_NAME if set.  [required]
  --skip-sqs-check           If set, will skip confirming that the SQS is
                             empty for 'full' harvest.
  -h, --help                 Show this message and exit.
```

### `harvester harvest ogm`

```text
Usage: -c harvest ogm [OPTIONS]

  Harvest and normalize OpenGeoMetadata (OGM) geospatial metadata records.

  NOTE: relies on 'harvest' command group arguments

Options:
  --config-yaml-file TEXT  Filepath of config YAML that defines how to harvest
                           from OGM.  [required]
  -h, --help               Show this message and exit.
```